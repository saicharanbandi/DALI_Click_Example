<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2017-11-14 Di 17:24 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>&lrm;</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Foo X. Bar" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2017 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<div class="org-src-container">
<pre class="src src-C"><span style="color: #b218b2;">#include</span> <span style="color: #ff1f8b;">&lt;DALI_Slave_Pub.h&gt;</span>
<span style="color: #b218b2;">#include</span> <span style="color: #ff1f8b;">&lt;DALI_defs.h&gt;</span>
<span style="color: #b218b2;">#include</span> <span style="color: #ff1f8b;">&lt;DALI_Slave_Defs.h&gt;</span>
<span style="color: #b218b2;">#include</span> <span style="color: #ff1f8b;">&lt;Timer_Slave.h&gt;</span>

<span style="color: #b2b2b2; font-style: italic;">// </span><span style="color: #b2b2b2; font-style: italic;">Initialise all 64 Ballasts with offset in a memory.</span>
<span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> *<span style="color: #ff8700;">ptrAddr</span>;

<span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">dali_state</span>;

<span style="color: #00af00;">volatile</span> <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">dali_array_cmd</span>[17];
<span style="color: #00af00;">volatile</span> <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">dali_array_receive_buffer</span>[9];

<span style="color: #b2b2b2; font-style: italic;">////</span><span style="color: #b2b2b2; font-style: italic;">volatile unsigned char settling_state;</span>

<span style="color: #00af00;">volatile</span> <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">expect_backchannel</span>;
<span style="color: #00af00;">volatile</span> <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">expected_response</span>;

<span style="color: #00af00;">volatile</span> <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">tmpg</span>;

<span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">for slave device</span>
<span style="color: #00af00;">volatile</span> <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">dali_slave_array_receive_buffer</span>[17];
<span style="color: #00af00;">volatile</span> <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">dali_slave_array_response</span>[9];

<span style="color: #00af00;">volatile</span> <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">dali_slave_answer</span>;

<span style="color: #00af00;">volatile</span> <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">slave_addr_byte_received</span>;
<span style="color: #00af00;">volatile</span> <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">slave_cmd_byte_received</span>;

<span style="color: #00af00;">volatile</span> <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">fadeBorder</span>;
<span style="color: #00af00;">volatile</span> <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">count_fade_steps</span>;

<span style="color: #b2b2b2; font-style: italic;">//</span>
<span style="color: #00af00;">volatile</span> <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">redrawUI</span>;

<span style="color: #b2b2b2; font-style: italic;">//</span>
<span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">actual_val</span>;
<span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">former_val</span>;

<span style="color: #00af00;">volatile</span> <span style="color: #18b2b2;">LightObjectType</span> <span style="color: #ff8700;">lightLeds</span>[10];

<span style="color: #18b2b2;">void</span> <span style="color: #ef2929;">DALI_Slave_Group_Cmd</span>(<span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">addrByte</span>, <span style="color: #18b2b2;">LightObjectType</span> *<span style="color: #ff8700;">ptrLight</span>);

<span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ef2929;">DALI_Slave_getAddressFromByte</span>(<span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">addressByte</span>);
<span style="color: #18b2b2;">void</span> <span style="color: #ef2929;">DALI_Slave_WriteArcValue</span>(<span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">ballastAddress</span>, <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">arcValue</span>);

<span style="color: #18b2b2;">void</span> <span style="color: #ef2929;">DALI_Slave_Set_Fade</span>(<span style="color: #18b2b2;">LightObjectType</span> *<span style="color: #ff8700;">ptrLights</span>, <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">addrByte</span>, <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">fadeTypeDir</span>);

<span style="color: #18b2b2;">void</span> <span style="color: #ef2929;">DALI_Slave_TurnOff_Ballast</span>(<span style="color: #18b2b2;">LightObjectType</span> *<span style="color: #ff8700;">lightObjs</span>, <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">ObjId</span>);
<span style="color: #18b2b2;">void</span> <span style="color: #ef2929;">DALI_Slave_Set_Arc_Level</span>(<span style="color: #18b2b2;">LightObjectType</span> *<span style="color: #ff8700;">lightObjs</span>, <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">ObjId</span>,
                                <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">valueType</span>, <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">ledOn</span>);
<span style="color: #18b2b2;">void</span> <span style="color: #ef2929;">DALI_Slave_Set_Arc_Level_Direct</span>(<span style="color: #18b2b2;">LightObjectType</span> *<span style="color: #ff8700;">lightObjs</span>, <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">ObjId</span>, <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">arcValue</span>);
<span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ef2929;">DALI_Slave_Has_Group</span>(<span style="color: #18b2b2;">LightObjectType</span> *<span style="color: #ff8700;">lightObjs</span>, <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">ObjId</span>, <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">addrByte</span>);


<span style="color: #b2b2b2; font-style: italic;">/*******************************************************************************</span>
<span style="color: #b2b2b2; font-style: italic;">Function:       DALI_Slave_Fade_PWM</span>
<span style="color: #b2b2b2; font-style: italic;">Description:    Fade led for 200ms</span>

<span style="color: #b2b2b2; font-style: italic;">******************************************************************************</span><span style="color: #b2b2b2; font-style: italic;">*/</span>

<span style="color: #18b2b2;">void</span> <span style="color: #ef2929;">DALI_Slave_Fade_PWM</span>(<span style="color: #18b2b2;">void</span>)
{
  Timer_DALI_Fade_Init();
}

<span style="color: #b2b2b2; font-style: italic;">/*******************************************************************************</span>
<span style="color: #b2b2b2; font-style: italic;">Function:       DALI_Slave_Fade_Step_PWM</span>
<span style="color: #b2b2b2; font-style: italic;">Description:    Fade leds for one step. Called from timer interrupt.</span>

<span style="color: #b2b2b2; font-style: italic;">******************************************************************************</span><span style="color: #b2b2b2; font-style: italic;">*/</span>

<span style="color: #18b2b2;">void</span> <span style="color: #ef2929;">DALI_Slave_Fade_Step_PWM</span>()
{
  <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">i</span>;

  <span style="color: #00af00;">for</span> (i = 0; i &lt; 10; i++)
  {
    <span style="color: #00af00;">if</span>(lightLeds[i]._to_fade != FADE_NONE)
    {
      <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">fade up for 1 step; watch for max arc level value</span>
      <span style="color: #00af00;">if</span>(lightLeds[i]._to_fade == FADE_UP &amp;&amp; lightLeds[i]._arcLevel &lt; 254)
      {
        lightLeds[i]._arcLevel += 1;
      }
      <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">fade down for 1 step; watch for min arc level value</span>
      <span style="color: #00af00;">if</span>(lightLeds[i]._to_fade == FADE_DOWN &amp;&amp; lightLeds[i]._arcLevel &gt; 1)
        lightLeds[i]._arcLevel -= 1;
    }
  }
}


<span style="color: #b2b2b2; font-style: italic;">/*******************************************************************************</span>
<span style="color: #b2b2b2; font-style: italic;">Function:       DALI_Slave_Init</span>
<span style="color: #b2b2b2; font-style: italic;">Description:    Initialise slave device; all ballasts etc</span>

<span style="color: #b2b2b2; font-style: italic;">******************************************************************************</span><span style="color: #b2b2b2; font-style: italic;">*/</span>

<span style="color: #18b2b2;">void</span> <span style="color: #ef2929;">DALI_Slave_Init</span>(<span style="color: #18b2b2;">void</span>)
{
  <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">i</span>;
  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">set default value for state flag</span>
  dali_state = NO_ACTION;
  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">initialise Timer module</span>
  Timer_DALI_Init();
  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">initialise memory space and default values</span>
  DALI_Slave_Mem_Init();

  former_val = 1;
  actual_val = 1;
  ptrAddr = ADDR_BALLAST_MEM;
  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">inicialisation of leds on system board</span>
  <span style="color: #00af00;">for</span>(i = 0; i &lt; 10; i++)
  {
    lightLeds[i]._address = i;
    lightLeds[i]._on = TRUE;
    lightLeds[i]._arcLevel = 254;
    lightLeds[i]._group0_7 = *(ptrAddr + BALLAST_SLAVE_OFFSET * i + BALLAST_GROUP_0_7);
    lightLeds[i]._group8_15 = *(ptrAddr + BALLAST_SLAVE_OFFSET * i + BALLAST_GROUP_8_15);
    lightLeds[i]._to_fade  = FADE_NONE;
  }
}

<span style="color: #b2b2b2; font-style: italic;">/*******************************************************************************</span>
<span style="color: #b2b2b2; font-style: italic;">Function:       DALI_Slave_Mem_Init</span>
<span style="color: #b2b2b2; font-style: italic;">Description:    Initialise memory space in SRAM where ballasts data will be stored</span>

<span style="color: #b2b2b2; font-style: italic;">NOTE:           Initialise memory for ballasts.</span>
<span style="color: #b2b2b2; font-style: italic;">******************************************************************************</span><span style="color: #b2b2b2; font-style: italic;">*/</span>

<span style="color: #18b2b2;">void</span> <span style="color: #ef2929;">DALI_Slave_Mem_Init</span>(<span style="color: #18b2b2;">void</span>)
{
  <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">i</span>;

  ptrAddr = ADDR_BALLAST_MEM;
  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">for every ballast. Default values by protocol</span>
  <span style="color: #00af00;">for</span>(i = 0; i &lt; 64; i++)
  {
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">write short address to memory</span>
    *(ptrAddr + BALLAST_SLAVE_OFFSET * i + BALLAST_SHORT_ADDRESS)         = i;
    *(ptrAddr + BALLAST_SLAVE_OFFSET * i + BALLAST_ACTUAL_DIM_LEVEL)      = 0;
    *(ptrAddr + BALLAST_SLAVE_OFFSET * i + BALLAST_POWER_ON_LEVEL)        = 254;
    *(ptrAddr + BALLAST_SLAVE_OFFSET * i + BALLAST_SYSTEM_FAILURE_LEVEL)  = 254;
    *(ptrAddr + BALLAST_SLAVE_OFFSET * i + BALLAST_MIN_LEVEL)             = 1;
    *(ptrAddr + BALLAST_SLAVE_OFFSET * i + BALLAST_MAX_LEVEL)             = 254;
    *(ptrAddr + BALLAST_SLAVE_OFFSET * i + BALLAST_FADE_RATE)             = 7;
    *(ptrAddr + BALLAST_SLAVE_OFFSET * i + BALLAST_FADE_TIME)             = 1;
    *(ptrAddr + BALLAST_SLAVE_OFFSET * i + BALLAST_SEARCH_ADDRESS_H)      = 0;
    *(ptrAddr + BALLAST_SLAVE_OFFSET * i + BALLAST_SEARCH_ADDRESS_M)      = 0;
    *(ptrAddr + BALLAST_SLAVE_OFFSET * i + BALLAST_SEARCH_ADDRESS_L)      = 0;
    *(ptrAddr + BALLAST_SLAVE_OFFSET * i + BALLAST_RANDOM_ADDRESS_H)      = 0;
    *(ptrAddr + BALLAST_SLAVE_OFFSET * i + BALLAST_RANDOM_ADDRESS_M)      = 0;
    *(ptrAddr + BALLAST_SLAVE_OFFSET * i + BALLAST_RANDOM_ADDRESS_L)      = 0;
    *(ptrAddr + BALLAST_SLAVE_OFFSET * i + BALLAST_GROUP_0_7)             = 0;
    *(ptrAddr + BALLAST_SLAVE_OFFSET * i + BALLAST_GROUP_8_15)            = 0;
    *(ptrAddr + BALLAST_SLAVE_OFFSET * i + BALLAST_SCENE_01)              = 0;
    *(ptrAddr + BALLAST_SLAVE_OFFSET * i + BALLAST_SCENE_02)              = 254;
    *(ptrAddr + BALLAST_SLAVE_OFFSET * i + BALLAST_SCENE_03)              = 190;
    *(ptrAddr + BALLAST_SLAVE_OFFSET * i + BALLAST_SCENE_04)              = 0;
    *(ptrAddr + BALLAST_SLAVE_OFFSET * i + BALLAST_SCENE_05)              = 0;
    *(ptrAddr + BALLAST_SLAVE_OFFSET * i + BALLAST_SCENE_06)              = 254;
    *(ptrAddr + BALLAST_SLAVE_OFFSET * i + BALLAST_SCENE_07)              = 254;
    *(ptrAddr + BALLAST_SLAVE_OFFSET * i + BALLAST_SCENE_08)              = 80;
    *(ptrAddr + BALLAST_SLAVE_OFFSET * i + BALLAST_SCENE_09)              = 190;
    *(ptrAddr + BALLAST_SLAVE_OFFSET * i + BALLAST_SCENE_10)              = 200;
    *(ptrAddr + BALLAST_SLAVE_OFFSET * i + BALLAST_SCENE_11)              = 50;
    *(ptrAddr + BALLAST_SLAVE_OFFSET * i + BALLAST_SCENE_12)              = 30;
    *(ptrAddr + BALLAST_SLAVE_OFFSET * i + BALLAST_SCENE_13)              = 254;
    *(ptrAddr + BALLAST_SLAVE_OFFSET * i + BALLAST_SCENE_14)              = 0;
    *(ptrAddr + BALLAST_SLAVE_OFFSET * i + BALLAST_SCENE_15)              = 0;
    *(ptrAddr + BALLAST_SLAVE_OFFSET * i + BALLAST_SCENE_16)              = 100;
    *(ptrAddr + BALLAST_SLAVE_OFFSET * i + BALLAST_STATUS_INFORMATION)    = 0;
    *(ptrAddr + BALLAST_SLAVE_OFFSET * i + BALLAST_VERSION_NUMBER)        = 0;
    *(ptrAddr + BALLAST_SLAVE_OFFSET * i + BALLAST_PHYSICAL_MIN_LEVEL)    = 1;
  }
  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">only for example</span>
  *(ptrAddr + BALLAST_GROUP_0_7)                                          = 0x2D;
  *(ptrAddr + BALLAST_SLAVE_OFFSET + BALLAST_GROUP_0_7)                   = 0x35;
  *(ptrAddr + BALLAST_SLAVE_OFFSET * 2 + BALLAST_GROUP_0_7)               = 0x11;
  *(ptrAddr + BALLAST_SLAVE_OFFSET * 3 + BALLAST_GROUP_0_7)               = 0x15;
  *(ptrAddr + BALLAST_SLAVE_OFFSET * 4 + BALLAST_GROUP_0_7)               = 0x29;
  *(ptrAddr + BALLAST_SLAVE_OFFSET * 5 + BALLAST_GROUP_0_7)               = 0x2D;
  *(ptrAddr + BALLAST_SLAVE_OFFSET * 6 + BALLAST_GROUP_0_7)               = 0x2A;
  *(ptrAddr + BALLAST_SLAVE_OFFSET * 7 + BALLAST_GROUP_0_7)               = 0x2A;
  *(ptrAddr + BALLAST_SLAVE_OFFSET * 8 + BALLAST_GROUP_0_7)               = 0x2A;
  *(ptrAddr + BALLAST_SLAVE_OFFSET * 9 + BALLAST_GROUP_0_7)               = 0x3A;
}

<span style="color: #b2b2b2; font-style: italic;">/******************************************************************************</span>
<span style="color: #b2b2b2; font-style: italic;">Function:       DALI_Send_Cmd</span>
<span style="color: #b2b2b2; font-style: italic;">Description:    Send DALI command over DALI protocol</span>

<span style="color: #b2b2b2; font-style: italic;">Inputs:         * ballastAddr - Address of the ballast (dimmer)</span>

<span style="color: #b2b2b2; font-style: italic;">                * cmd         - Command which is going to be sent (see DALI_defs.h for list</span>
<span style="color: #b2b2b2; font-style: italic;">                              of commands)</span>

<span style="color: #b2b2b2; font-style: italic;">                * typeOfCmd   - It's used to define type of address:</span>
<span style="color: #b2b2b2; font-style: italic;">                                - BROADCAST_DIRECT</span>
<span style="color: #b2b2b2; font-style: italic;">                                - BROADCAST_CMD</span>
<span style="color: #b2b2b2; font-style: italic;">                                - SHORT_ADDRESS</span>
<span style="color: #b2b2b2; font-style: italic;">                                - GROUP_ADDRESS</span>

<span style="color: #b2b2b2; font-style: italic;">                * followingType - Status of the last bit in address byte.</span>
<span style="color: #b2b2b2; font-style: italic;">                                  - FOLLOWING_DIRECT_ARC_POWER_LVL</span>
<span style="color: #b2b2b2; font-style: italic;">                                  - FOLLOWING_COMMAND</span>

<span style="color: #b2b2b2; font-style: italic;">Output:      TRUE</span>
<span style="color: #b2b2b2; font-style: italic;">*****************************************************************************</span><span style="color: #b2b2b2; font-style: italic;">*/</span>
<span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ef2929;">DALI_Send_Cmd</span>(<span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">ballastAddr</span>, <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">cmd</span>,
                            <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">typeOfCmd</span>, <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">followingType</span>)
{
  <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">data_array</span>[2];
  <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">i</span>;

  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">how much time the command will be repeated - for test</span>
  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">dali_cmd_repeat_time = 3;</span>

  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">set output pin to 0</span>
  _OUT_LINE = 1;

  tick_count = 0;
  bit_count  = 0;
  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">set DALI state to send data</span>
  dali_state = SENDING_DATA;
  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">fetch ballast address and command</span>
  data_array[0] = (<span style="color: #18b2b2;">char</span>)ballastAddr;
  data_array[1] = (<span style="color: #18b2b2;">char</span>)cmd;

  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">reset dali_array_cmd values</span>
  <span style="color: #00af00;">for</span> (i = 0; i &lt; 17; i++)         <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">16</span>
    dali_array_cmd[i] = 0;

  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">prepare address byte to be sent</span>
  PrepareAddressByte(data_array, typeOfCmd, 0, followingType);

  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">encode data - Manchester encoding</span>
  PrepareDataToSend(data_array, dali_array_cmd, 2);

  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">check type of command</span>
  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">set backchannel</span>
  <span style="color: #00af00;">if</span>((cmd &gt;= 0x00) &amp;&amp; (cmd &lt;= 0x1F)) <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">Indirect arc power control commands</span>
  {
    expect_backchannel   = FALSE;
  }
  <span style="color: #00af00;">if</span>((cmd &gt;= 20) &amp;&amp; (cmd &lt;= 0x80)) <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">Configurations commands</span>
  {
    expect_backchannel = FALSE;
  }
  <span style="color: #00af00;">if</span>((cmd &gt;= 0x90))                <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">Query commands</span>
  {
    expect_backchannel = TRUE;     <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">set status to expect Backchannel. Posible answer:</span>
                                   <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">1111 1111                             - YES</span>
                                   <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">no response; no ba1ckchannel received  - NO</span>
                                   <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">8bit info                             - 8 bit</span>
  }
  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">check for special command</span>
  <span style="color: #00af00;">if</span>(DALI_Check_Special_Cmd(data_array[0]))
  {
    expect_backchannel = TRUE;
    <span style="color: #b2b2b2; font-style: italic;">//</span>
    <span style="color: #00af00;">if</span>(data_array[0] == TERMINATE_H_BITS || data_array[0] == DTR)
      expect_backchannel = FALSE;
    <span style="color: #00af00;">else</span> <span style="color: #00af00;">if</span>(data_array[0] == VERIFY_SHORT_ADDRESS || data_array[0] == QUERY_SHORT_ADDRESS_H)
      expect_backchannel = TRUE;
    <span style="color: #00af00;">else</span>
      expect_backchannel = FALSE;


  }

  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">start timer</span>
  Timer_Start();

  <span style="color: #00af00;">return</span> TRUE;
}

<span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ef2929;">DALI_Check_Special_Cmd</span>(<span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">addrByte</span>)
{
  <span style="color: #00af00;">volatile</span> <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">addrToCheck</span>;

  addrToCheck = addrByte;    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">get address byte</span>
  <span style="color: #00af00;">if</span> ((addrToCheck == 0x90) || (addrToCheck == 0xA0)) <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">check for 1010 or 1011</span>
  {
    <span style="color: #00af00;">if</span>(addrToCheck &amp; 0x01) <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">LSB must be 1</span>
      <span style="color: #00af00;">return</span> TRUE;
    <span style="color: #00af00;">else</span>
      <span style="color: #00af00;">return</span> FALSE;
  }
  <span style="color: #00af00;">else</span>
  {
    <span style="color: #00af00;">return</span> FALSE;
  }
}

<span style="color: #b2b2b2; font-style: italic;">/*******************************************************************************</span>
<span style="color: #b2b2b2; font-style: italic;">Function:       DALI_Slave_Receiving_Data</span>
<span style="color: #b2b2b2; font-style: italic;">Description:    Check status of IN line and write to array</span>

<span style="color: #b2b2b2; font-style: italic;">Note:           Manchester encoding</span>

<span style="color: #b2b2b2; font-style: italic;">******************************************************************************</span><span style="color: #b2b2b2; font-style: italic;">*/</span>

<span style="color: #18b2b2;">void</span> <span style="color: #ef2929;">DALI_Slave_Receiving_Data</span>(<span style="color: #18b2b2;">void</span>)
{
  <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">pulsePosition</span>;
  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">forward frame - 17 bits to receive - last 2 don't change phase</span>
  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">first bit is start bit (1), ignore, also last 2 bits are stop bits</span>
  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">FF - BF settlling time 7Te - 22Te (2Te = 8 interrupt intervals)</span>
  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">when change on pin is detected, tick_count is restarted.</span>

    <span style="color: #00af00;">if</span>(tick_count == (<span style="color: #18b2b2;">bit_count</span> * 8 + 2))
    {
      <span style="color: #00af00;">if</span>(_IN_LINE == 1)
        dali_slave_array_receive_buffer[bit_count] = 0;
      <span style="color: #00af00;">else</span>
        dali_slave_array_receive_buffer[bit_count] = 1;
    }

  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">increment ticks</span>
  tick_count++;

  <span style="color: #00af00;">if</span>(tick_count % 8 == 0)
    bit_count++;

  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">transfer completed</span>
  <span style="color: #00af00;">if</span>(bit_count &gt; 16)
  {
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">set dali state</span>
    dali_state = FORWARD_FRAME_RECEIVED;
  }
}

<span style="color: #b2b2b2; font-style: italic;">/*******************************************************************************</span>
<span style="color: #b2b2b2; font-style: italic;">Function:       DALI_Slave_Sending_Data</span>
<span style="color: #b2b2b2; font-style: italic;">Description:    Check status of IN line and send data to master device</span>

<span style="color: #b2b2b2; font-style: italic;">Note:           Manchester encoding</span>

<span style="color: #b2b2b2; font-style: italic;">******************************************************************************</span><span style="color: #b2b2b2; font-style: italic;">*/</span>

<span style="color: #18b2b2;">void</span> <span style="color: #ef2929;">DALI_Slave_Sending_Data</span>(<span style="color: #18b2b2;">void</span>)
{
  <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">pulsePosition</span>;

  <span style="color: #00af00;">if</span>(tick_count &lt; 8)
  {
    <span style="color: #00af00;">if</span>(tick_count &lt; 4)
      _OUT_LINE = 0;
    <span style="color: #00af00;">else</span>
      _OUT_LINE = 1;
  }
  <span style="color: #00af00;">else</span>
  <span style="color: #00af00;">if</span>(bit_count &lt; 9)
  {
    <span style="color: #00af00;">if</span>(tick_count % 4 == 0)
    {
      pulsePosition = tick_count / 4;
      <span style="color: #00af00;">if</span>(pulsePosition % 2 == 0)
      {
        <span style="color: #00af00;">if</span>(dali_slave_array_response[bit_count] == DALI_START_BIT_PULSE)
          _OUT_LINE = 1;
        <span style="color: #00af00;">else</span>
          _OUT_LINE = 0;
      }
      <span style="color: #00af00;">else</span>
      {
        <span style="color: #00af00;">if</span>(dali_slave_array_response[bit_count] == DALI_START_BIT_PULSE)
          _OUT_LINE = 0;
        <span style="color: #00af00;">else</span>
          _OUT_LINE = 1;
      }
    }
  }
  tick_count++;

  <span style="color: #00af00;">if</span>(tick_count % 8 == 0)
    bit_count++;

  <span style="color: #00af00;">if</span>(bit_count &gt; 8)
  {
    dali_state = BACKWARD_FRAME_SENT;
    _OUT_LINE  = 1;
    _IN_LINE   = 1;
  }
}

<span style="color: #b2b2b2; font-style: italic;">/*******************************************************************************</span>
<span style="color: #b2b2b2; font-style: italic;">Function:       PrepareDataToSend</span>
<span style="color: #b2b2b2; font-style: italic;">Description:    Prepare command array to be encoded and create new array where</span>
<span style="color: #b2b2b2; font-style: italic;">                every element is a bit.</span>

<span style="color: #b2b2b2; font-style: italic;">Parameters:     * commandArray - Array of bytes values</span>

<span style="color: #b2b2b2; font-style: italic;">                * tx_array     - Return array. Each element represents bit state</span>

<span style="color: #b2b2b2; font-style: italic;">                * bytesInCmd   - Number of bytes in command array</span>


<span style="color: #b2b2b2; font-style: italic;">Note:           Manchester encoding</span>

<span style="color: #b2b2b2; font-style: italic;">******************************************************************************</span><span style="color: #b2b2b2; font-style: italic;">*/</span>

<span style="color: #18b2b2;">void</span> <span style="color: #ef2929;">PrepareDataToSend</span>(<span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> *<span style="color: #ff8700;">commandArray</span>, <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> *<span style="color: #ff8700;">tx_array</span>, 
                       <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">bytesInCmd</span>)
{
  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">set default valur for the mask</span>
  <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">mask</span> = 0x80;
  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">variable which hold one byte value - one element from commandArray</span>
  <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">dummy</span>;
  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">number of bytes in command</span>
  <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">bytes_counter</span>;
  <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">i</span>;
  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">number of active bit</span>
  <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">bitCounter</span>;
  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">set default value</span>
  bitCounter = 0;

  <span style="color: #00af00;">for</span> (i = 0; i &lt; 9; i++)
  {
    tx_array[0] = 0;
  }

  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">loop through all bytes in commandArray</span>
  <span style="color: #00af00;">for</span>(bytes_counter = 0; bytes_counter &lt; bytesInCmd; bytes_counter++)
  {
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">assign byte for use</span>
    dummy = commandArray[bytes_counter];
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">set mask to default value</span>
    mask = 0x80;
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">increment number of active bit</span>
    bitCounter++;

    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">check if active bit is the first one</span>
    <span style="color: #00af00;">if</span>(bitCounter == 1)
    {
      <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">start bit is always 1 - in manchester that is END_BIT_PULSE</span>
      tx_array[0] = DALI_END_BIT_PULSE;
    }
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">2 byte command</span>
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">go through all bytes and use Manchester</span>
    <span style="color: #00af00;">for</span>(i = 1; i &lt; 9; i++) <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">1 &amp; 9</span>
    {
      <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">check if bit is one</span>
      <span style="color: #00af00;">if</span>(dummy &amp; mask)
      {
        <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">assign pulse value - manchester</span>
        tx_array[i + (8 * bytes_counter)] = DALI_END_BIT_PULSE;
      }
      <span style="color: #00af00;">else</span>
      {
        <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">assign pulse value - manchester</span>
        tx_array[i + (8 * bytes_counter)] = DALI_START_BIT_PULSE;
      }
      <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">check mask value</span>
      <span style="color: #00af00;">if</span>(mask == 0x01)
        mask &lt;&lt;= 7;     <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">shift mask bit to MSB</span>
      <span style="color: #00af00;">else</span>
        mask &gt;&gt;= 1;     <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">shift mask bit to 1 right</span>
    }
  }
  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">tx_array[17] = DALI_END_BIT_PULSE;</span>

  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">add 2 stop bits at the end</span>
<span style="color: #b2b2b2; font-style: italic;">/*</span><span style="color: #b2b2b2; font-style: italic;">for (i = 1; i &lt; 3; i++)</span>
<span style="color: #b2b2b2; font-style: italic;">  {</span>
<span style="color: #b2b2b2; font-style: italic;">    //assign pulse value - manchester</span>
<span style="color: #b2b2b2; font-style: italic;">    tx_array[16 + i] = DALI_END_BIT_PULSE;</span>
<span style="color: #b2b2b2; font-style: italic;">  }</span><span style="color: #b2b2b2; font-style: italic;">*/</span>
}

<span style="color: #b2b2b2; font-style: italic;">/*******************************************************************************</span>
<span style="color: #b2b2b2; font-style: italic;">Function:       DALI_Slave_PWM_Set_Duty</span>
<span style="color: #b2b2b2; font-style: italic;">Description:    Set 1 step fade</span>

<span style="color: #b2b2b2; font-style: italic;">******************************************************************************</span><span style="color: #b2b2b2; font-style: italic;">*/</span>

<span style="color: #18b2b2;">void</span> <span style="color: #ef2929;">DALI_Slave_PWM_Set_Duty</span>(<span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">arclevel</span>, <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">addressBallast</span>)
{
  <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">int</span> <span style="color: #ff8700;">currentDuty</span>;

  currentDuty = arclevel;

  <span style="color: #00af00;">switch</span>(addressBallast)
  {
    <span style="color: #00af00;">case</span> 0 : {
              PWM_TIM1_Set_Duty(currentDuty, _PWM_NON_INVERTED, _PWM_CHANNEL1);
              <span style="color: #00af00;">break</span>;
             }
    <span style="color: #00af00;">case</span> 1 : {
              PWM_TIM1_Set_Duty(currentDuty, _PWM_NON_INVERTED, _PWM_CHANNEL2);
              <span style="color: #00af00;">break</span>;
             }
    <span style="color: #00af00;">case</span> 2 : {
              PWM_TIM1_Set_Duty(currentDuty, _PWM_NON_INVERTED, _PWM_CHANNEL3);
              <span style="color: #00af00;">break</span>;
             }
    <span style="color: #00af00;">case</span> 3 : {
              PWM_TIM1_Set_Duty(currentDuty, _PWM_NON_INVERTED, _PWM_CHANNEL4);
              <span style="color: #00af00;">break</span>;
             }
    <span style="color: #00af00;">case</span> 4 : {
              PWM_TIM3_Set_Duty(currentDuty, _PWM_NON_INVERTED, _PWM_CHANNEL1);
              <span style="color: #00af00;">break</span>;
             }
    <span style="color: #00af00;">case</span> 5 : {
              PWM_TIM3_Set_Duty(currentDuty, _PWM_NON_INVERTED, _PWM_CHANNEL2);
              <span style="color: #00af00;">break</span>;
             }
    <span style="color: #00af00;">case</span> 6 : {
              PWM_TIM3_Set_Duty(currentDuty, _PWM_NON_INVERTED, _PWM_CHANNEL3);
              <span style="color: #00af00;">break</span>;
             }
    <span style="color: #00af00;">case</span> 7 : {
              PWM_TIM3_Set_Duty(currentDuty, _PWM_NON_INVERTED, _PWM_CHANNEL4);
              <span style="color: #00af00;">break</span>;
             }
    <span style="color: #00af00;">case</span> 8 : {
              PWM_TIM8_Set_Duty(currentDuty, _PWM_NON_INVERTED, _PWM_CHANNEL1);
              <span style="color: #00af00;">break</span>;
             }
    <span style="color: #00af00;">case</span> 9 : {
              PWM_TIM8_Set_Duty(currentDuty, _PWM_NON_INVERTED, _PWM_CHANNEL2);
              <span style="color: #00af00;">break</span>;
             }
  }
}


<span style="color: #b2b2b2; font-style: italic;">/*******************************************************************************</span>
<span style="color: #b2b2b2; font-style: italic;">Function:       DALI_Slave_PWM_TIM1_Init</span>
<span style="color: #b2b2b2; font-style: italic;">Description:    Initialisa PWM module</span>

<span style="color: #b2b2b2; font-style: italic;">******************************************************************************</span><span style="color: #b2b2b2; font-style: italic;">*/</span>

<span style="color: #18b2b2;">void</span> <span style="color: #ef2929;">DALI_Slave_PWM_TIM1_Init</span>(<span style="color: #18b2b2;">void</span>)
{
  PWM_TIM1_Init(656250);  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">256 steps</span>

  PWM_TIM1_Set_Duty(250, _PWM_NON_INVERTED, _PWM_CHANNEL4);
  PWM_TIM1_Set_Duty(250, _PWM_NON_INVERTED, _PWM_CHANNEL3);
  PWM_TIM1_Set_Duty(250, _PWM_NON_INVERTED, _PWM_CHANNEL2);
  PWM_TIM1_Set_Duty(250, _PWM_NON_INVERTED, _PWM_CHANNEL1);
  PWM_TIM1_Start(_PWM_CHANNEL1, &amp;_GPIO_MODULE_TIM1_CH1_PE9);
  PWM_TIM1_Start(_PWM_CHANNEL2, &amp;_GPIO_MODULE_TIM1_CH2_PA9);
  PWM_TIM1_Start(_PWM_CHANNEL3, &amp;_GPIO_MODULE_TIM1_CH3_PA10);
  PWM_TIM1_Start(_PWM_CHANNEL4, &amp;_GPIO_MODULE_TIM1_CH4_PE14);
}

<span style="color: #b2b2b2; font-style: italic;">/*******************************************************************************</span>
<span style="color: #b2b2b2; font-style: italic;">Function:       DALI_Slave_PWM_TIM3_Init</span>
<span style="color: #b2b2b2; font-style: italic;">Description:    Initialisa PWM module</span>

<span style="color: #b2b2b2; font-style: italic;">******************************************************************************</span><span style="color: #b2b2b2; font-style: italic;">*/</span>

<span style="color: #18b2b2;">void</span> <span style="color: #ef2929;">DALI_Slave_PWM_TIM3_Init</span>(<span style="color: #18b2b2;">void</span>)
{
  PWM_TIM3_Init(656250);  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">256 steps</span>

  PWM_TIM3_Set_Duty(250, _PWM_NON_INVERTED, _PWM_CHANNEL4);
  PWM_TIM3_Set_Duty(250, _PWM_NON_INVERTED, _PWM_CHANNEL3);
  PWM_TIM3_Set_Duty(250, _PWM_NON_INVERTED, _PWM_CHANNEL2);
  PWM_TIM3_Set_Duty(250, _PWM_NON_INVERTED, _PWM_CHANNEL1);
  PWM_TIM3_Start(_PWM_CHANNEL1, &amp;_GPIO_MODULE_TIM3_CH1_PA6);
  PWM_TIM3_Start(_PWM_CHANNEL2, &amp;_GPIO_MODULE_TIM3_CH2_PB5);
  PWM_TIM3_Start(_PWM_CHANNEL3, &amp;_GPIO_MODULE_TIM3_CH3_PC8);
  PWM_TIM3_Start(_PWM_CHANNEL4, &amp;_GPIO_MODULE_TIM3_CH4_PC9);
}

<span style="color: #b2b2b2; font-style: italic;">/*******************************************************************************</span>
<span style="color: #b2b2b2; font-style: italic;">Function:       DALI_Slave_PWM_TIM3_Init</span>
<span style="color: #b2b2b2; font-style: italic;">Description:    Initialisa PWM module</span>

<span style="color: #b2b2b2; font-style: italic;">******************************************************************************</span><span style="color: #b2b2b2; font-style: italic;">*/</span>

<span style="color: #18b2b2;">void</span> <span style="color: #ef2929;">DALI_Slave_PWM_TIM8_Init</span>(<span style="color: #18b2b2;">void</span>)
{
  PWM_TIM8_Init(656250);  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">256 steps</span>

  PWM_TIM8_Set_Duty(250, _PWM_NON_INVERTED, _PWM_CHANNEL1);
  PWM_TIM8_Set_Duty(250, _PWM_NON_INVERTED, _PWM_CHANNEL2);
  PWM_TIM8_Start(_PWM_CHANNEL1, &amp;_GPIO_MODULE_TIM8_CH1_PC6);
  PWM_TIM8_Start(_PWM_CHANNEL2, &amp;_GPIO_MODULE_TIM8_CH2_PC7);
}

<span style="color: #b2b2b2; font-style: italic;">/*******************************************************************************</span>
<span style="color: #b2b2b2; font-style: italic;">Function:       DALI_Slave_Cmd_OFF</span>
<span style="color: #b2b2b2; font-style: italic;">Description:    Turn off ballasts.</span>

<span style="color: #b2b2b2; font-style: italic;">******************************************************************************</span><span style="color: #b2b2b2; font-style: italic;">*/</span>

<span style="color: #18b2b2;">void</span> <span style="color: #ef2929;">DALI_Slave_Cmd_OFF</span>(<span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">addrByte</span>)
{
<span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">i</span>;
  <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">addrBallast</span>;

  <span style="color: #00af00;">if</span>(addrByte == BROADCAST_CMD)
  {
    <span style="color: #00af00;">for</span>(i = 0; i &lt; 10; i++)
    {
      DALI_Slave_TurnOff_Ballast(lightLeds, i);
    }
  }
  <span style="color: #00af00;">else</span> <span style="color: #00af00;">if</span> ((addrByte &amp; 0x80))
  {
    <span style="color: #00af00;">for</span> (i = 0; i &lt; 10; i++)
    {
      <span style="color: #00af00;">if</span>(DALI_Slave_Has_Group(lightLeds, i, addrByte))
      {
        DALI_Slave_TurnOff_Ballast(lightLeds, i);
      }
    }
  }
  <span style="color: #00af00;">else</span>
  {
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">get address</span>
    addrBallast = DALI_Slave_getAddressFromByte(addrByte);
    DALI_Slave_TurnOff_Ballast(lightLeds, addrBallast);
  }
}

<span style="color: #b2b2b2; font-style: italic;">/*******************************************************************************</span>
<span style="color: #b2b2b2; font-style: italic;">Function:       DALI_Slave_Cmd_RECALL_MIN_LEVEL</span>
<span style="color: #b2b2b2; font-style: italic;">Description:    Set the actual arc power level to the &#145;MIN LEVEL&#146; without fading.</span>
<span style="color: #b2b2b2; font-style: italic;">                If the lamp is off it shall be ignited with this command.</span>

<span style="color: #b2b2b2; font-style: italic;">******************************************************************************</span><span style="color: #b2b2b2; font-style: italic;">*/</span>

<span style="color: #18b2b2;">void</span> <span style="color: #ef2929;">DALI_Slave_Cmd_RECALL_MIN_LEVEL</span>(<span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">addrByte</span>)
{
  <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">i</span>;
  <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">addrBallast</span>;

  ptrAddr = ADDR_BALLAST_MEM;

  <span style="color: #00af00;">if</span>(addrByte == BROADCAST_CMD)
  {
    <span style="color: #00af00;">for</span>(i = 0; i &lt; 10; i++)
    {
      DALI_Slave_Set_Arc_Level(lightLeds, i, BALLAST_MIN_LEVEL, TRUE);
      DALI_Slave_PWM_Set_Duty(lightLeds[i]._arcLevel, lightLeds[i]._address);
    }
  }
   <span style="color: #00af00;">else</span> <span style="color: #00af00;">if</span>((addrbyte &amp; 0x80))
  {
    <span style="color: #00af00;">for</span> (i=0; i &lt; 10; i++)
    {
      <span style="color: #00af00;">if</span>(DALI_Slave_Has_Group(lightLeds, i, addrByte))
      {
        DALI_Slave_Set_Arc_Level(lightLeds, i, BALLAST_MIN_LEVEL, TRUE);
        DALI_Slave_PWM_Set_Duty(lightLeds[i]._arcLevel, lightLeds[i]._address);
      }
    }
  }
  <span style="color: #00af00;">else</span>
  {
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">get address</span>
    addrBallast = DALI_Slave_getAddressFromByte(addrByte);
    DALI_Slave_Set_Arc_Level(lightLeds, addrBallast, BALLAST_MIN_LEVEL, TRUE);
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">pwm to arc level</span>
    DALI_Slave_PWM_Set_Duty(lightLeds[addrBallast]._arcLevel, lightLeds[addrBallast]._address);
  }
}

<span style="color: #b2b2b2; font-style: italic;">/*******************************************************************************</span>
<span style="color: #b2b2b2; font-style: italic;">Function:       DALI_Slave_Group_Cmd</span>
<span style="color: #b2b2b2; font-style: italic;">Description:    Execute command on ballast with specific group</span>

<span style="color: #b2b2b2; font-style: italic;">******************************************************************************</span><span style="color: #b2b2b2; font-style: italic;">*/</span>
<span style="color: #18b2b2;">void</span> <span style="color: #ef2929;">DALI_Slave_Group_Cmd</span>(<span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">addrByte</span>, <span style="color: #18b2b2;">LightObjectType</span> *<span style="color: #ff8700;">ptrLight</span>)
{
<span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">groupAddress</span>;
    <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">i</span>;

    groupAddress = addrByte &lt;&lt; 3;
    groupAddress = groupAddress &gt;&gt; 4;

    <span style="color: #00af00;">for</span>(i = 0; i &lt; 10; i++)
    {
       <span style="color: #00af00;">if</span>(DALI_Slave_Has_Group(lightLeds, i, addrByte))
       {
         DALI_Slave_Set_Arc_Level(ptrLight, i, BALLAST_MAX_LEVEL, TRUE);
       }
       <span style="color: #00af00;">else</span>
         DALI_Slave_TurnOff_Ballast(ptrLight, i);
    }
}

<span style="color: #b2b2b2; font-style: italic;">/*******************************************************************************</span>
<span style="color: #b2b2b2; font-style: italic;">Function:       DALI_Slave_Cmd_RECALL_MAX_LEVEL</span>
<span style="color: #b2b2b2; font-style: italic;">Description:    Set the actual arc power level to the &#145;MAX LEVEL&#146; without fading.</span>
<span style="color: #b2b2b2; font-style: italic;">                If the lamp is off it shall be ignited with this command.</span>

<span style="color: #b2b2b2; font-style: italic;">******************************************************************************</span><span style="color: #b2b2b2; font-style: italic;">*/</span>

<span style="color: #18b2b2;">void</span> <span style="color: #ef2929;">DALI_Slave_Cmd_RECALL_MAX_LEVEL</span>(<span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">addrByte</span>)
{
  <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">i</span>;
  <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">addrBallast</span>;

  ptrAddr = ADDR_BALLAST_MEM;

  <span style="color: #00af00;">if</span>(addrByte == BROADCAST_CMD)
  {
    <span style="color: #00af00;">for</span>(i = 0; i &lt; 10; i++)
    {
      DALI_Slave_Set_Arc_Level(lightLeds, i, BALLAST_MAX_LEVEL, TRUE);
      DALI_Slave_PWM_Set_Duty(lightLeds[i]._arcLevel, lightLeds[i]._address);
    }
  }
  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">group command</span>
  <span style="color: #00af00;">else</span> <span style="color: #00af00;">if</span> ((addrByte &amp; GROUP_ADDRESS) == 0x80)
  {
    <span style="color: #00af00;">for</span> (i=0; i &lt; 10; i++)
    {
      <span style="color: #00af00;">if</span>(DALI_Slave_Has_Group(lightLeds, i, addrByte))
      {
        DALI_Slave_Set_Arc_Level(lightLeds, i, BALLAST_MAX_LEVEL, TRUE);
        DALI_Slave_PWM_Set_Duty(lightLeds[i]._arcLevel, lightLeds[i]._address);
      }
    }
  }
  <span style="color: #00af00;">else</span>
  {
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">get address</span>
    addrBallast = DALI_Slave_getAddressFromByte(addrByte);
    DALI_Slave_Set_Arc_Level(lightLeds, addrBallast, BALLAST_MAX_LEVEL, TRUE);
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">pwm</span>
    DALI_Slave_PWM_Set_Duty(lightLeds[addrBallast]._arcLevel, lightLeds[addrBallast]._address);
  }
}

<span style="color: #b2b2b2; font-style: italic;">/*******************************************************************************</span>
<span style="color: #b2b2b2; font-style: italic;">Function:       DALI_Slave_Cmd_GO_TO_SCENE</span>
<span style="color: #b2b2b2; font-style: italic;">Description:    Set the actual arc power level to the value stored for scene XXXX</span>
<span style="color: #b2b2b2; font-style: italic;">                using the actual fade time. If the ballast does not belong to scene</span>
<span style="color: #b2b2b2; font-style: italic;">                XXXX, the arc power level remain unchanged. If the lamp is off it</span>
<span style="color: #b2b2b2; font-style: italic;">                shall be ignited with this command.</span>

<span style="color: #b2b2b2; font-style: italic;">******************************************************************************</span><span style="color: #b2b2b2; font-style: italic;">*/</span>

<span style="color: #18b2b2;">void</span> <span style="color: #ef2929;">DALI_Slave_Cmd_GO_TO_SCENE</span>(<span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">addrByte</span>, <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">scene</span>)
{
  <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">i</span>;
  <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">addrBallast</span>;
  <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">sceneLevel</span>;

  ptrAddr = ADDR_BALLAST_MEM;

  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">get scene from byte</span>
  sceneLevel = scene &amp; 0x0F;

  <span style="color: #00af00;">if</span>(addrByte == BROADCAST_CMD)
  {
    <span style="color: #00af00;">for</span> (i = 0; i &lt; 10; i++)
    {
      <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">set arc level to scene level</span>
      DALI_Slave_Set_Arc_Level(lightLeds, i, (BALLAST_SCENE_01 + sceneLevel), TRUE);
      DALI_Slave_PWM_Set_Duty(lightLeds[i]._arcLevel, lightLeds[i]._address);
    }
  }
  <span style="color: #00af00;">else</span> <span style="color: #00af00;">if</span> ((addrByte &amp; GROUP_ADDRESS) == 0x80)
  {
    <span style="color: #00af00;">for</span> (i=0; i &lt; 10; i++)
    {
      <span style="color: #00af00;">if</span>(DALI_Slave_Has_Group(lightLeds, i, addrByte))
      {
        DALI_Slave_Set_Arc_Level(lightLeds, i, (BALLAST_SCENE_01 + sceneLevel), TRUE);
        DALI_Slave_PWM_Set_Duty(lightLeds[i]._arcLevel, lightLeds[i]._address);
      }
    }
  }
  <span style="color: #00af00;">else</span>
  {
     <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">get address</span>
     addrBallast = DALI_Slave_getAddressFromByte(addrByte);
     DALI_Slave_Set_Arc_Level(lightLeds, addrBallast, (BALLAST_SCENE_01 + sceneLevel), TRUE);
     DALI_Slave_PWM_Set_Duty(lightLeds[addrBallast]._arcLevel, lightLeds[addrBallast]._address);
  }
}

<span style="color: #b2b2b2; font-style: italic;">/*******************************************************************************</span>
<span style="color: #b2b2b2; font-style: italic;">Function:       DALI_Slave_getAddressFromByte</span>
<span style="color: #b2b2b2; font-style: italic;">Description:    Get the address from address byte.</span>

<span style="color: #b2b2b2; font-style: italic;">******************************************************************************</span><span style="color: #b2b2b2; font-style: italic;">*/</span>

<span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ef2929;">DALI_Slave_getAddressFromByte</span>(<span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">addressByte</span>)
{
  <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">addressToReturn</span>;

  addressToReturn = addressByte &lt;&lt; 1;
  addressToReturn = addressToReturn &gt;&gt; 2;

  <span style="color: #00af00;">return</span> addressToReturn;
}

<span style="color: #b2b2b2; font-style: italic;">/*******************************************************************************</span>
<span style="color: #b2b2b2; font-style: italic;">Function:       DALI_Slave_WriteArcValue</span>
<span style="color: #b2b2b2; font-style: italic;">Description:    Write arc value to memory for specific led</span>

<span style="color: #b2b2b2; font-style: italic;">******************************************************************************</span><span style="color: #b2b2b2; font-style: italic;">*/</span>

<span style="color: #18b2b2;">void</span> <span style="color: #ef2929;">DALI_Slave_WriteArcValue</span>(<span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">ballastAddress</span>, <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">arcValue</span>)
{
  ptrAddr = ADDR_BALLAST_MEM;
  *(ptrAddr + BALLAST_SLAVE_OFFSET * ballastAddress + BALLAST_ACTUAL_DIM_LEVEL) = arcValue;
}

<span style="color: #b2b2b2; font-style: italic;">/*******************************************************************************</span>
<span style="color: #b2b2b2; font-style: italic;">Function:       DALI_Slave_Cmd_STEP_UP</span>
<span style="color: #b2b2b2; font-style: italic;">Description:    Set the actual arc power level one step higher immediately</span>
<span style="color: #b2b2b2; font-style: italic;">                without fading.</span>

<span style="color: #b2b2b2; font-style: italic;">******************************************************************************</span><span style="color: #b2b2b2; font-style: italic;">*/</span>

<span style="color: #18b2b2;">void</span> <span style="color: #ef2929;">DALI_Slave_Cmd_STEP_UP</span>(<span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">addrByte</span>)
{
  <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">i</span>;
  <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">addrBallast</span>;
  <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">stepUpValue</span>;

  ptrAddr = ADDR_BALLAST_MEM;

  <span style="color: #00af00;">if</span>(addrByte == BROADCAST_CMD || (addrByte &amp; GROUP_ADDRESS))
  {
    <span style="color: #00af00;">for</span> (i = 0; i &lt; 10; i++)
    {
      <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">only active lights</span>
      <span style="color: #00af00;">if</span> (lightLeds[i]._on)
      {
        <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">get FADE RATE</span>
        stepUpValue = *(ptrAddr + BALLAST_SLAVE_OFFSET * lightLeds[i]._address + BALLAST_FADE_RATE);
        <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">check max level</span>
        <span style="color: #00af00;">if</span>((lightLeds[i]._arcLevel + stepUpValue) &lt; *(ptrAddr + BALLAST_SLAVE_OFFSET * lightLeds[i]._address + BALLAST_MAX_LEVEL))
        {
          <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">add one step</span>
          lightLeds[i]._arcLevel += stepUpValue;
        }
        <span style="color: #00af00;">else</span>
        {
          <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">set max level</span>
          lightLeds[i]._arcLevel = *(ptrAddr + BALLAST_SLAVE_OFFSET * lightLeds[i]._address + BALLAST_MAX_LEVEL);
        }
        <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">write back to memory</span>
        DALI_Slave_WriteArcValue(lightLeds[i]._address, lightLeds[i]._arcLevel);

        <span style="color: #00af00;">if</span>(addrByte == BROADCAST_CMD)
          DALI_Slave_PWM_Set_Duty(lightLeds[i]._arcLevel, lightLeds[i]._address);

      }
    }
    <span style="color: #00af00;">if</span>(((addrByte &amp; GROUP_ADDRESS) == 0x80) &amp;&amp; (addrByte != BROADCAST_CMD) &amp;&amp; (addrByte != BROADCAST_DIRECT))
      DALI_Slave_Group_Cmd(addrByte, lightLeds);
  }
  <span style="color: #00af00;">else</span>
  {
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">only active light</span>
      addrBallast = DALI_Slave_getAddressFromByte(addrByte);
      <span style="color: #00af00;">if</span> (lightLeds[addrBallast]._on)
      {
        <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">get FADE RATE</span>
        stepUpValue = *(ptrAddr + BALLAST_SLAVE_OFFSET * lightLeds[addrBallast]._address + BALLAST_FADE_RATE);
        <span style="color: #00af00;">if</span>((lightLeds[addrBallast]._arcLevel + stepUpValue) &lt; *(ptrAddr + BALLAST_SLAVE_OFFSET * lightLeds[addrBallast]._address + BALLAST_MAX_LEVEL))
        {
          <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">add one step</span>
          lightLeds[addrBallast]._arcLevel += stepUpValue;
        }
        <span style="color: #00af00;">else</span>
        {
          <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">set maximum arc level</span>
          lightLeds[addrBallast]._arcLevel = *(ptrAddr + BALLAST_SLAVE_OFFSET * lightLeds[addrBallast]._address + BALLAST_MAX_LEVEL);
        }
        <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">write to memory</span>
        DALI_Slave_WriteArcValue(lightLeds[addrBallast]._address, lightLeds[addrBallast]._arcLevel);
        <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">pwm deo</span>
        DALI_Slave_PWM_Set_Duty(lightLeds[addrBallast]._arcLevel, lightLeds[addrBallast]._address);
      }
  }
}

<span style="color: #b2b2b2; font-style: italic;">/*******************************************************************************</span>
<span style="color: #b2b2b2; font-style: italic;">Function:       DALI_Slave_Cmd_STEP_DOWN</span>
<span style="color: #b2b2b2; font-style: italic;">Description:    Set the actual arc power level one step lower immediately without</span>
<span style="color: #b2b2b2; font-style: italic;">                fading.</span>

<span style="color: #b2b2b2; font-style: italic;">******************************************************************************</span><span style="color: #b2b2b2; font-style: italic;">*/</span>

<span style="color: #18b2b2;">void</span> <span style="color: #ef2929;">DALI_Slave_Cmd_STEP_DOWN</span>(<span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">addrByte</span>)
{
  <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">i</span>;
  <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">addrBallast</span>;
  <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">stepDownValue</span>;

  ptrAddr = ADDR_BALLAST_MEM;

  <span style="color: #00af00;">if</span>(addrByte == BROADCAST_CMD || (addrByte &amp; GROUP_ADDRESS))
  {
    <span style="color: #00af00;">for</span> (i = 0; i &lt; 16; i++)
    {
      <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">only active lights</span>
      <span style="color: #00af00;">if</span> (lightLeds[i]._on)
      {
        <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">get FADE RATE</span>
        stepDownValue = *(ptrAddr + BALLAST_SLAVE_OFFSET * lightLeds[i]._address + BALLAST_FADE_RATE);
        <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">check max level</span>
        <span style="color: #00af00;">if</span>((lightLeds[i]._arcLevel - stepDownValue) &gt; *(ptrAddr + BALLAST_SLAVE_OFFSET * lightLeds[i]._address + BALLAST_MIN_LEVEL))
        {
          <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">one step down</span>
          lightLeds[i]._arcLevel -= stepDownValue;
        }
        <span style="color: #00af00;">else</span>
        {
          <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">set min level</span>
          lightLeds[i]._arcLevel = *(ptrAddr + BALLAST_SLAVE_OFFSET * lightLeds[i]._address + BALLAST_MIN_LEVEL);
        }
        <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">write back to memory</span>
        DALI_Slave_WriteArcValue(lightLeds[i]._address, lightLeds[i]._arcLevel);
        <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">pwm</span>
        <span style="color: #00af00;">if</span>(addrByte == BROADCAST_CMD)
          DALI_Slave_PWM_Set_Duty(lightLeds[i]._arcLevel, lightLeds[i]._address);
      }
    }
    <span style="color: #00af00;">if</span>(((addrByte &amp; GROUP_ADDRESS) == 0x80) &amp;&amp; (addrByte != BROADCAST_CMD) &amp;&amp; (addrByte != BROADCAST_DIRECT))
      DALI_Slave_Group_Cmd(addrByte, lightLeds);
  }
  <span style="color: #00af00;">else</span>
  {
    addrBallast = DALI_Slave_getAddressFromByte(addrByte);

    <span style="color: #00af00;">if</span>(lightLeds[addrBallast]._on)
    {
      <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">get FADE RATE</span>
      stepDownValue = *(ptrAddr + BALLAST_SLAVE_OFFSET * lightLeds[addrBallast]._address + BALLAST_FADE_RATE);
      <span style="color: #00af00;">if</span>((lightLeds[addrBallast]._arcLevel - stepDownValue) &gt; *(ptrAddr + BALLAST_SLAVE_OFFSET * addrBallast + BALLAST_MIN_LEVEL))   <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">lightLeds[addrBallast]._address + BALLAST_MIN_LEVEL))</span>
      {
        <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">one step down</span>
        lightLeds[addrBallast]._arcLevel -= stepDownValue;
      }
      <span style="color: #00af00;">else</span>
      {
        <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">set minimum arc level</span>
        lightLeds[addrBallast]._arcLevel = *(ptrAddr + BALLAST_SLAVE_OFFSET * lightLeds[addrBallast]._address + BALLAST_MIN_LEVEL);
      }
      <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">write to memory</span>
      DALI_Slave_WriteArcValue(lightLeds[addrBallast]._address, lightLeds[addrBallast]._arcLevel);
      <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">pwm deo</span>
      DALI_Slave_PWM_Set_Duty(lightLeds[addrBallast]._arcLevel, lightLeds[addrBallast]._address);
    }
  }
}

<span style="color: #b2b2b2; font-style: italic;">/*******************************************************************************</span>
<span style="color: #b2b2b2; font-style: italic;">Function:       DALI_Slave_Cmd_DOWN</span>
<span style="color: #b2b2b2; font-style: italic;">Description:    Dim down 200 ms using the selected FADE RATE</span>

<span style="color: #b2b2b2; font-style: italic;">******************************************************************************</span><span style="color: #b2b2b2; font-style: italic;">*/</span>

<span style="color: #18b2b2;">void</span> <span style="color: #ef2929;">DALI_Slave_Cmd_DOWN</span>(<span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">addrByte</span>)
{
  fadeBorder = 45;
  DALI_Slave_Set_Fade(lightLeds, addrByte, FADE_DOWN);
  DALI_Slave_Fade_PWM();
}

<span style="color: #b2b2b2; font-style: italic;">/*******************************************************************************</span>
<span style="color: #b2b2b2; font-style: italic;">Function:       DALI_Slave_Cmd_UP</span>
<span style="color: #b2b2b2; font-style: italic;">Description:    Dim up 200ms using selected fade rate</span>

<span style="color: #b2b2b2; font-style: italic;">******************************************************************************</span><span style="color: #b2b2b2; font-style: italic;">*/</span>
<span style="color: #18b2b2;">void</span> <span style="color: #ef2929;">DALI_Slave_Cmd_UP</span>(<span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">addrByte</span>)
{
  fadeBorder = 45;
  DALI_Slave_Set_Fade(lightLeds, addrByte, FADE_UP);
  DALI_Slave_Fade_PWM();
}

<span style="color: #b2b2b2; font-style: italic;">/*******************************************************************************</span>
<span style="color: #b2b2b2; font-style: italic;">Function:       DALI_Slave_Cmd_STEP_DOWN_AND_OFF</span>
<span style="color: #b2b2b2; font-style: italic;">Description:    Set the actual arc power level one step lower immediately without </span>
<span style="color: #b2b2b2; font-style: italic;">                fading. If the actual arc power level is already at the &#145;MIN LEVEL&#146; </span>
<span style="color: #b2b2b2; font-style: italic;">                the lamp shall be switched off by this command.</span>

<span style="color: #b2b2b2; font-style: italic;">******************************************************************************</span><span style="color: #b2b2b2; font-style: italic;">*/</span>

<span style="color: #18b2b2;">void</span> <span style="color: #ef2929;">DALI_Slave_Cmd_STEP_DOWN_AND_OFF</span>(<span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">addrByte</span>)
{
  <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">i</span>;
  <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">addrBallast</span>;
  <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">stepDownValue</span>;
  <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">minArcValue</span>;
  <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">mask</span>;

  ptrAddr = ADDR_BALLAST_MEM;

  <span style="color: #00af00;">if</span>(addrByte == BROADCAST_CMD || (addrByte &amp; GROUP_ADDRESS))
  {
    <span style="color: #00af00;">for</span>(i = 0; i &lt; 10; i++)
    {
      stepDownValue = *(ptrAddr + BALLAST_SLAVE_OFFSET * lightLeds[i]._address + BALLAST_FADE_RATE);
      <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">get min arc value for ballast</span>
      minArcValue = *(ptrAddr + BALLAST_SLAVE_OFFSET * lightLeds[i]._address + BALLAST_MIN_LEVEL);
      <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">below min value, set to min</span>
      <span style="color: #00af00;">if</span>((lightLeds[i]._arcLevel - stepDownValue) &lt; minArcValue)
      {
        lightLeds[i]._arcLevel = minArcValue;
      }
      <span style="color: #00af00;">else</span> <span style="color: #00af00;">if</span>(lightLeds[i]._arcLevel == minArcValue) <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">turn off light</span>
      {
        lightLeds[i]._on = FALSE;
        lightLeds[i]._arcLevel = 0;
      }
      <span style="color: #00af00;">else</span> <span style="color: #00af00;">if</span>((lightLeds[i]._arcLevel - stepDownValue) &gt; minArcValue)
      {
        <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">step down</span>
        lightLeds[i]._arcLevel -= stepDownValue;
      }
      <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">write to memory</span>
      DALI_Slave_WriteArcValue(lightLeds[i]._address, lightLeds[i]._arcLevel);
      <span style="color: #00af00;">if</span>(lightLeds[i]._on)
      {
        <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">pwm</span>
        <span style="color: #00af00;">if</span>(addrByte == BROADCAST_CMD)
          DALI_Slave_PWM_Set_Duty(lightLeds[i]._arcLevel, Lightleds[i]._address);
      }
    }
    <span style="color: #00af00;">if</span>(((addrByte &amp; GROUP_ADDRESS) == 0x80) &amp;&amp; (addrByte != BROADCAST_CMD) &amp;&amp; (addrByte != BROADCAST_DIRECT))
      DALI_Slave_Group_Cmd(addrByte, lightLeds);
  }
  <span style="color: #00af00;">else</span>
  {
    addrBallast = DALI_Slave_getAddressFromByte(addrByte);
    stepDownValue = *(ptrAddr + BALLAST_SLAVE_OFFSET * lightLeds[addrBallast]._address + BALLAST_FADE_RATE);
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">get min arc value for ballast</span>
    minArcValue = *(ptrAddr + BALLAST_SLAVE_OFFSET * lightLeds[i]._address + BALLAST_MIN_LEVEL);
    <span style="color: #00af00;">if</span>((lightLeds[addrBallast]._arcLevel - stepDownValue) &lt; minArcValue)
      {
        lightLeds[addrBallast]._arcLevel = minArcValue;
      }
      <span style="color: #00af00;">else</span> <span style="color: #00af00;">if</span>(lightLeds[addrBallast]._arcLevel == minArcValue) <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">turn off light</span>
      {
        lightLeds[addrBallast]._on = FALSE;
        lightLeds[addrBallast]._arcLevel = 0;
      }
      <span style="color: #00af00;">else</span> <span style="color: #00af00;">if</span>((lightLeds[addrBallast]._arcLevel - stepDownValue) &gt; minArcValue)
      {
        <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">step down</span>
        lightLeds[addrBallast]._arcLevel -= stepDownValue;
      }
      <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">write to memory</span>
      DALI_Slave_WriteArcValue(lightLeds[addrBallast]._address, lightLeds[addrBallast]._arcLevel);
      <span style="color: #00af00;">if</span>(lightLeds[addrBallast]._on)
      {
        <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">pwm deo</span>
        DALI_Slave_PWM_Set_Duty(lightLeds[addrBallast]._arcLevel, lightLeds[addrBallast]._address);
      }
  }
}

<span style="color: #b2b2b2; font-style: italic;">/*******************************************************************************</span>
<span style="color: #b2b2b2; font-style: italic;">Function:       DALI_Slave_Cmd_ON_AND_STEP_UP</span>
<span style="color: #b2b2b2; font-style: italic;">Description:    Set the actual arc power level one step higher immediately without</span>
<span style="color: #b2b2b2; font-style: italic;">                fading. If the lamp is switched off the lamp shall be ignited with </span>
<span style="color: #b2b2b2; font-style: italic;">                this command and shall be set to the &#145;MIN LEVEL&#146;.</span>

<span style="color: #b2b2b2; font-style: italic;">******************************************************************************</span><span style="color: #b2b2b2; font-style: italic;">*/</span>

<span style="color: #18b2b2;">void</span> <span style="color: #ef2929;">DALI_Slave_Cmd_ON_AND_STEP_UP</span>(<span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">addrByte</span>)
{
  <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">i</span>;
  <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">minArcValue</span>;
  <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">maxArcValue</span>;
  <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">stepUpValue</span>;
  <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">addrBallast</span>;

  ptrAddr = ADDR_BALLAST_MEM;

  <span style="color: #00af00;">if</span>(addrByte == BROADCAST_CMD)
  {
    <span style="color: #00af00;">for</span>(i = 0; i &lt; 10; i++)
    {
      <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">get fade value</span>
      stepUpValue = *(ptrAddr + BALLAST_SLAVE_OFFSET * lightLeds[i]._address + BALLAST_FADE_RATE);
      <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">get min arc level value</span>
      minArcValue = *(ptrAddr + BALLAST_SLAVE_OFFSET * lightLeds[i]._address + BALLAST_MIN_LEVEL);
      <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">get max arc level value</span>
      maxArcValue = *(ptrAddr + BALLAST_SLAVE_OFFSET * lightLeds[i]._address + BALLAST_MAX_LEVEL);
      <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">turn on light and set to min arc level</span>
      <span style="color: #00af00;">if</span>(lightLeds[i]._on == FALSE)
      {
        lightLeds[i]._on = TRUE;                     <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">turn on led</span>
        lightLeds[i]._arcLevel = minArcValue;        <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">set arc level</span>
      }
      <span style="color: #00af00;">else</span>
      {
        <span style="color: #00af00;">if</span>((lightLeds[i]._arcLevel + stepUpValue) &lt; maxArcValue)
        {
          lightLeds[i]._arcLevel += stepUpValue;
        }
        <span style="color: #00af00;">else</span>
        {
          lightLeds[i]._arcLevel = maxArcValue;
        }
      }
      <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">write to memory</span>
      DALI_Slave_WriteArcValue(lightLeds[i]._address, lightLeds[i]._arcLevel);
      <span style="color: #00af00;">if</span>(addrByte == BROADCAST_CMD)
        DALI_Slave_PWM_Set_Duty(lightLeds[i]._arcLevel, lightLeds[i]._address);
    }
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">pwm deo</span>
    <span style="color: #00af00;">if</span>(((addrByte &amp; GROUP_ADDRESS) == 0x80) &amp;&amp; (addrByte != BROADCAST_CMD) &amp;&amp; (addrByte != BROADCAST_DIRECT))
      DALI_Slave_Group_Cmd(addrByte, lightLeds);

  }
  <span style="color: #00af00;">else</span> <span style="color: #00af00;">if</span>((addrByte &amp; 0x80) == 0)
  {
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">get address</span>
    addrBallast = DALI_Slave_getAddressFromByte(addrByte);
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">get fade value</span>
    stepUpValue = *(ptrAddr + BALLAST_SLAVE_OFFSET * lightLeds[addrBallast]._address + BALLAST_FADE_RATE);
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">get min arc level value</span>
    minArcValue = *(ptrAddr + BALLAST_SLAVE_OFFSET * lightLeds[addrBallast]._address + BALLAST_MIN_LEVEL);
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">get max arc level value</span>
    maxArcValue = *(ptrAddr + BALLAST_SLAVE_OFFSET * lightLeds[addrBallast]._address + BALLAST_MAX_LEVEL);

    <span style="color: #00af00;">if</span>(lightLeds[i]._on == FALSE)
    {
      lightLeds[i]._on = TRUE;
      lightLeds[i]._arcLevel = minArcValue;
    }
    <span style="color: #00af00;">else</span>
    {
      <span style="color: #00af00;">if</span>((lightLeds[i]._arcLevel + stepUpValue) &lt; maxArcValue)
      {
        lightLeds[addrBallast]._arcLevel += stepUpValue;
      }
      <span style="color: #00af00;">else</span>
      {
        lightLeds[addrBallast]._arcLevel = maxArcValue;
      }
    }
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">write to memory</span>
    DALI_Slave_WriteArcValue(lightLeds[addrBallast]._address, lightLeds[addrBallast]._arcLevel);
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">pwm</span>
    DALI_Slave_PWM_Set_Duty(lightLeds[addrBallast]._arcLevel, lightLeds[addrBallast]._address);
  }
}

<span style="color: #b2b2b2; font-style: italic;">/*******************************************************************************</span>
<span style="color: #b2b2b2; font-style: italic;">Function:       DALI_Slave_Execute_command</span>
<span style="color: #b2b2b2; font-style: italic;">Description:    Prepare ballast data to send or execute specific no-response command.</span>

<span style="color: #b2b2b2; font-style: italic;">Parameters:     * addrByte - address byte from master device</span>

<span style="color: #b2b2b2; font-style: italic;">                * cmdByte  - command byte from master device</span>


<span style="color: #b2b2b2; font-style: italic;">******************************************************************************</span><span style="color: #b2b2b2; font-style: italic;">*/</span>

<span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ef2929;">DALI_Slave_Execute_Command</span>(<span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">addrByte</span>, <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">cmdByte</span>)
{
  <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">i</span>;
  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">ballast number from address byte</span>
  <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">numberOfBallast</span>;
  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">value from memory</span>
  <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">returnData</span>;
  <span style="color: #00af00;">volatile</span> <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">addr</span>;
  addr = addrByte;
  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">get ballast number</span>
  numberOfBallast = addrByte &lt;&lt; 1;
  numberOfBallast = numberOfBallast &gt;&gt; 2;
  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">start location for pointer - location of SHORT ADDRESS</span>
  ptrAddr = ADDR_BALLAST_MEM;

  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">redraw UI</span>
  redrawUI = TRUE;

  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">direct arc level command - short address, arc level following</span>
  <span style="color: #00af00;">if</span>((addr &amp; FOLLOWING_COMMAND) == 0)
  {
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">short address</span>
    <span style="color: #00af00;">if</span>((addrByte &amp; GROUP_ADDRESS) == 0)
    {
      DALI_Slave_Set_Arc_Level_Direct(lightLeds, numberOfBallast, cmdByte);
      DALI_Slave_PWM_Set_Duty(lightLeds[numberOfBallast]._arcLevel, lightLeds[numberOfBallast]._address);
    }
    <span style="color: #00af00;">else</span>                    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">group address</span>
    {
      <span style="color: #00af00;">for</span> (i = 0; i &lt; 10; i++)
      {
        DALI_Slave_TurnOff_Ballast(lightLeds, i);
        <span style="color: #00af00;">if</span>(DALI_Slave_Has_Group(lightLeds, i, addrByte))
        {
          DALI_Slave_Set_Arc_Level_Direct(lightLeds, i, cmdByte);
          DALI_Slave_PWM_Set_Duty(lightLeds[i]._arcLevel, lightLeds[i]._address);
        }
      }
    }
  }
  <span style="color: #00af00;">else</span>  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">other commands, queries etc.</span>
  {
    <span style="color: #00af00;">switch</span>(cmdByte)
    {
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">OFF</span>
    <span style="color: #00af00;">case</span> OFF : {
                  DALI_Slave_Cmd_OFF(addrByte);
                  <span style="color: #00af00;">return</span> 0;
                  <span style="color: #00af00;">break</span>;
                }
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">UP</span>
    <span style="color: #00af00;">case</span> UP  : {
                  DALI_Slave_Cmd_UP(addrByte);
                  <span style="color: #00af00;">return</span> 0;
                  <span style="color: #00af00;">break</span>;
               }
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">DOWN</span>
    <span style="color: #00af00;">case</span> DOWN : {
                  DALI_Slave_Cmd_DOWN(addrByte);
                  <span style="color: #00af00;">return</span> 0;
                  <span style="color: #00af00;">break</span>;
                }
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">STEP UP</span>
    <span style="color: #00af00;">case</span> STEP_UP : {
                     DALI_Slave_Cmd_STEP_UP(addrByte);
                     <span style="color: #00af00;">return</span> 0;
                     <span style="color: #00af00;">break</span>;
                   }
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">STEP DOWN</span>
    <span style="color: #00af00;">case</span> STEP_DOWN : {
                       DALI_Slave_Cmd_STEP_DOWN(addrByte);
                       <span style="color: #00af00;">return</span> 0;
                       <span style="color: #00af00;">break</span>;
                     }
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">RECALL MAX LEVEL</span>
    <span style="color: #00af00;">case</span> RECALL_MAX_LEVEL : {
                              DALI_Slave_Cmd_RECALL_MAX_LEVEL(addrByte);
                              <span style="color: #00af00;">return</span> 0;
                              <span style="color: #00af00;">break</span>;
                            }
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">RECALL MIN LEVEL</span>
    <span style="color: #00af00;">case</span> RECALL_MIN_LEVEL : {
                              DALI_Slave_Cmd_RECALL_MIN_LEVEL(addrByte);
                              <span style="color: #00af00;">return</span> 0;
                              <span style="color: #00af00;">break</span>;
                            }
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">STEP DOWN AND OFF</span>
    <span style="color: #00af00;">case</span> STEP_DOWN_AND_OFF : {
                               DALI_Slave_Cmd_STEP_DOWN_AND_OFF(addrByte);
                               <span style="color: #00af00;">return</span> 0;
                               <span style="color: #00af00;">break</span>;
                             }
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">ON AND STEP UP</span>
    <span style="color: #00af00;">case</span> ON_AND_STEP_UP : {
                            DALI_Slave_Cmd_ON_AND_STEP_UP(addrByte);
                            <span style="color: #00af00;">return</span> 0;
                            <span style="color: #00af00;">break</span>;
                          }
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">GO TO SCENE</span>
    <span style="color: #00af00;">case</span> GO_TO_SCENE01 :
    <span style="color: #00af00;">case</span> GO_TO_SCENE02 :
    <span style="color: #00af00;">case</span> GO_TO_SCENE03 :
    <span style="color: #00af00;">case</span> GO_TO_SCENE04 :
    <span style="color: #00af00;">case</span> GO_TO_SCENE05 :
    <span style="color: #00af00;">case</span> GO_TO_SCENE06 :
    <span style="color: #00af00;">case</span> GO_TO_SCENE07 :
    <span style="color: #00af00;">case</span> GO_TO_SCENE08 :
    <span style="color: #00af00;">case</span> GO_TO_SCENE09 :
    <span style="color: #00af00;">case</span> GO_TO_SCENE10 :
    <span style="color: #00af00;">case</span> GO_TO_SCENE11 :
    <span style="color: #00af00;">case</span> GO_TO_SCENE12 :
    <span style="color: #00af00;">case</span> GO_TO_SCENE13 :
    <span style="color: #00af00;">case</span> GO_TO_SCENE14 :
    <span style="color: #00af00;">case</span> GO_TO_SCENE15 :
    <span style="color: #00af00;">case</span> GO_TO_SCENE16 : {
                           DALI_Slave_Cmd_GO_TO_SCENE(addrByte, cmdByte);
                           <span style="color: #00af00;">return</span> 0;
                           <span style="color: #00af00;">break</span>;
                         }
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">Query Status</span>
    <span style="color: #00af00;">case</span> 0x90 : {
                  returnData = *(ptrAddr + BALLAST_SLAVE_OFFSET * numberOfBallast + BALLAST_STATUS_INFORMATION);
                  <span style="color: #00af00;">break</span>;
                }
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">Query Ballast</span>
    <span style="color: #00af00;">case</span> 0x91 : {
                  returnData = 255; <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">Ask if there is a ballast with the given address that is able to communicate. 255 - YES</span>
                  <span style="color: #00af00;">break</span>;
                }
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">Query Lamp Failure</span>
    <span style="color: #00af00;">case</span> 0x92 : {

                  <span style="color: #00af00;">break</span>;
                }
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">Query Lamp Power On</span>
    <span style="color: #00af00;">case</span> 0x93 : {

                  <span style="color: #00af00;">break</span>;
                }
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">Query Limit Error</span>
    <span style="color: #00af00;">case</span> 0x94 : {

                  <span style="color: #00af00;">break</span>;
                }
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">Query Reset State</span>
    <span style="color: #00af00;">case</span> 0x95 : {

                  <span style="color: #00af00;">break</span>;
                }
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">Query Missing Short Address</span>
    <span style="color: #00af00;">case</span> 0x96 : {

                  <span style="color: #00af00;">break</span>;
                }
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">Query Version Number</span>
    <span style="color: #00af00;">case</span> 0x97 : {
                  returnData = *(ptrAddr + BALLAST_SLAVE_OFFSET * numberOfBallast + BALLAST_VERSION_NUMBER);
                  <span style="color: #00af00;">break</span>;
                }
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">Query Content DTR</span>
    <span style="color: #00af00;">case</span> 0x98 : {

                  <span style="color: #00af00;">break</span>;
                }
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">Query Device Type</span>
    <span style="color: #00af00;">case</span> 0x99 : {

                  <span style="color: #00af00;">break</span>;
                }
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">Query Physical Minimum Level</span>
    <span style="color: #00af00;">case</span> 0x9A : {
                  returnData = *(ptrAddr + BALLAST_SLAVE_OFFSET * numberOfBallast + BALLAST_PHYSICAL_MIN_LEVEL);
                  <span style="color: #00af00;">break</span>;
                }
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">Query Power Failure</span>
    <span style="color: #00af00;">case</span> 0x9B : {

                  <span style="color: #00af00;">break</span>;

                }
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">Query Actual Level</span>
    <span style="color: #00af00;">case</span> 0xA0 : {
                  returnData = *(ptrAddr + BALLAST_SLAVE_OFFSET * numberOfBallast + BALLAST_ACTUAL_DIM_LEVEL);
                  <span style="color: #00af00;">break</span>;
                }
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">Query Max Level</span>
    <span style="color: #00af00;">case</span> 0xA1 : {
                  returnData = *(ptrAddr + BALLAST_SLAVE_OFFSET * numberOfBallast + BALLAST_MAX_LEVEL);
                  <span style="color: #00af00;">break</span>;
                }
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">Query Min Level</span>
    <span style="color: #00af00;">case</span> 0xA2 : {
                  returnData = *(ptrAddr + BALLAST_SLAVE_OFFSET * numberOfBallast + BALLAST_MIN_LEVEL);
                  <span style="color: #00af00;">break</span>;
                }
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">Query Power On Level</span>
    <span style="color: #00af00;">case</span> 0xA3 : {
                  returnData = *(ptrAddr + BALLAST_SLAVE_OFFSET * numberOfBallast + BALLAST_POWER_ON_LEVEL);
                  <span style="color: #00af00;">break</span>;
                }
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">Query System Failure Level</span>
    <span style="color: #00af00;">case</span> 0xA4 : {
                  returnData = *(ptrAddr + BALLAST_SLAVE_OFFSET * numberOfBallast + BALLAST_SYSTEM_FAILURE_LEVEL);
                  <span style="color: #00af00;">break</span>;
                }
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">Query Fade Time / Fade Rate</span>
    <span style="color: #00af00;">case</span> 0xA5 : {

                  <span style="color: #00af00;">break</span>;
                }
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">Query Scene Level</span>
    <span style="color: #00af00;">case</span> 0xB0 :
    <span style="color: #00af00;">case</span> 0xB1 :
    <span style="color: #00af00;">case</span> 0xB2 :
    <span style="color: #00af00;">case</span> 0xB3 :
    <span style="color: #00af00;">case</span> 0xB4 :
    <span style="color: #00af00;">case</span> 0xB5 :
    <span style="color: #00af00;">case</span> 0xB6 :
    <span style="color: #00af00;">case</span> 0xB7 :
    <span style="color: #00af00;">case</span> 0xB8 :
    <span style="color: #00af00;">case</span> 0xB9 :
    <span style="color: #00af00;">case</span> 0xBA :
    <span style="color: #00af00;">case</span> 0xBB :
    <span style="color: #00af00;">case</span> 0xBC :
    <span style="color: #00af00;">case</span> 0xBD :
    <span style="color: #00af00;">case</span> 0xBE :
    <span style="color: #00af00;">case</span> 0xBF : {
                  <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">tmp</span>;
                  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">get first 4 bits - scene number</span>
                  tmp = (cmdByte &amp; 0x0F);
                  returnData = *(ptrAddr + BALLAST_SLAVE_OFFSET * numberOfBallast + BALLAST_SCENE_01 + tmp);
                  <span style="color: #00af00;">break</span>;
                }
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">Query Groups 0-7</span>
    <span style="color: #00af00;">case</span> 0xC0 : {
                  returnData = *(ptrAddr + BALLAST_SLAVE_OFFSET * numberOfBallast + BALLAST_GROUP_0_7);
                  <span style="color: #00af00;">break</span>;
                }
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">Query Groups 8-15</span>
    <span style="color: #00af00;">case</span> 0xC1 : {
                  returnData = *(ptrAddr + BALLAST_SLAVE_OFFSET * numberOfBallast + BALLAST_GROUP_8_15);
                  <span style="color: #00af00;">break</span>;
                }
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">Query Random Address H</span>
    <span style="color: #00af00;">case</span> 0xC2 : {
                  returnData = *(ptrAddr + BALLAST_SLAVE_OFFSET * numberOfBallast + BALLAST_RANDOM_ADDRESS_H);
                  <span style="color: #00af00;">break</span>;
                }
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">Query Random Address M</span>
    <span style="color: #00af00;">case</span> 0xC3 : {
                  returnData = *(ptrAddr + BALLAST_SLAVE_OFFSET * numberOfBallast + BALLAST_RANDOM_ADDRESS_M);
                  <span style="color: #00af00;">break</span>;
                }
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">Query Random Address L</span>
    <span style="color: #00af00;">case</span> 0xC4 : {
                  returnData = *(ptrAddr + BALLAST_SLAVE_OFFSET * numberOfBallast + BALLAST_RANDOM_ADDRESS_L);
                  <span style="color: #00af00;">break</span>;
                }

  }

  }

  <span style="color: #00af00;">return</span> returnData;
}


<span style="color: #b2b2b2; font-style: italic;">/*******************************************************************************</span>
<span style="color: #b2b2b2; font-style: italic;">Function:       PrepareAddressByte</span>
<span style="color: #b2b2b2; font-style: italic;">Description:    Prepare address byte.</span>

<span style="color: #b2b2b2; font-style: italic;">Parameters:     * commandArray - Array of bytes values</span>

<span style="color: #b2b2b2; font-style: italic;">                * addressType  - It's used to define type of address:</span>
<span style="color: #b2b2b2; font-style: italic;">                                 - BROADCAST_DIRECT</span>
<span style="color: #b2b2b2; font-style: italic;">                                 - BROADCAST_CMD</span>
<span style="color: #b2b2b2; font-style: italic;">                                 - SHORT_ADDRESS</span>
<span style="color: #b2b2b2; font-style: italic;">                                 - GROUP_ADDRESS</span>

<span style="color: #b2b2b2; font-style: italic;">                * byteAddressPosition - Index of element in array which holds address</span>
<span style="color: #b2b2b2; font-style: italic;">                                        value</span>

<span style="color: #b2b2b2; font-style: italic;">                * followingType       - value of the last bit in address byte. Defines</span>
<span style="color: #b2b2b2; font-style: italic;">                                        if data byte holds command or direct arc value</span>
<span style="color: #b2b2b2; font-style: italic;">                                        - FOLLOWING_DIRECT_ARC_POWER_LVL</span>
<span style="color: #b2b2b2; font-style: italic;">                                        - FOLLOWING_COMMAND</span>
<span style="color: #b2b2b2; font-style: italic;">******************************************************************************</span><span style="color: #b2b2b2; font-style: italic;">*/</span>

<span style="color: #18b2b2;">void</span> <span style="color: #ef2929;">PrepareAddressByte</span>(<span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> *<span style="color: #ff8700;">commandArray</span>, <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">addressType</span>,
                        <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">byteAddressPosition</span>, <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">followingType</span>)
{
  <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">addr_tmp</span>;
  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">broadcast command to all ballasts</span>
  <span style="color: #00af00;">if</span>(addressType == BROADCAST_CMD)
  {
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">set address byte to Broadcast command - value 0xFF</span>
    commandArray[byteAddressPosition] = BROADCAST_CMD;
  }
  <span style="color: #00af00;">else</span>
  {
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">fetch address value from array to operate</span>
    addr_tmp = commandArray[byteAddressPosition];

    <span style="color: #00af00;">if</span> (addressType == BROADCAST_DIRECT)
      <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">broadcast direct arc level to all ballasts - value 0xFE</span>
      commandArray[byteAddressPosition] = BROADCAST_DIRECT;
    <span style="color: #00af00;">else</span>
    {
      <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">shift address value for 1 to left</span>
      addr_tmp &lt;&lt;= 1;

      <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">check if the command byte is following address byte</span>
      <span style="color: #00af00;">if</span>(followingType == FOLLOWING_COMMAND)
        <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">set LSB</span>
        addr_tmp |= 0x01;
      <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">if it is a group address</span>
      <span style="color: #00af00;">if</span> (addressType == GROUP_ADDRESS)
        <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">add group value to address byte</span>
        addr_tmp |= GROUP_ADDRESS;
      <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">assign return value</span>
      commandArray[byteAddressPosition] = addr_tmp;
    }
  }
}

<span style="color: #b2b2b2; font-style: italic;">/*******************************************************************************</span>
<span style="color: #b2b2b2; font-style: italic;">Function:       DALI_Get_Ballast_Answer</span>
<span style="color: #b2b2b2; font-style: italic;">Description:    Encode and write received data. Check in dali_array_receive_buffer</span>

<span style="color: #b2b2b2; font-style: italic;">Output:         Return ballast answer</span>
<span style="color: #b2b2b2; font-style: italic;">                - YES  : 1111 1111</span>
<span style="color: #b2b2b2; font-style: italic;">                - NO   : 0</span>
<span style="color: #b2b2b2; font-style: italic;">                - 8bit : XXXX XXXX - 8bit value</span>

<span style="color: #b2b2b2; font-style: italic;">******************************************************************************</span><span style="color: #b2b2b2; font-style: italic;">*/</span>

<span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ef2929;">DALI_Get_Ballast_Answer</span>(<span style="color: #18b2b2;">void</span>)
{
  <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">i</span>;
  <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">receivedData</span>;

  <span style="color: #00af00;">for</span> (i = 0; i &lt; 8; i++)
  {
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">shift bit to the right position</span>
    dali_array_receive_buffer[i] &lt;&lt;= i;
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">add bit to the received byte</span>
    receivedData |= dali_array_receive_buffer[i];
  }
  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">return received byte</span>
  <span style="color: #00af00;">return</span> receivedData;
}

<span style="color: #b2b2b2; font-style: italic;">/*******************************************************************************</span>
<span style="color: #b2b2b2; font-style: italic;">Function:       DALI_Slave_Status</span>
<span style="color: #b2b2b2; font-style: italic;">Description:    DALI slave device main loop</span>

<span style="color: #b2b2b2; font-style: italic;">Output:         Return DALI state</span>

<span style="color: #b2b2b2; font-style: italic;">******************************************************************************</span><span style="color: #b2b2b2; font-style: italic;">*/</span>

<span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ef2929;">DALI_Slave_Status</span>(<span style="color: #18b2b2;">void</span>)
{
  <span style="color: #00af00;">if</span>(dali_state == NO_ACTION)
  {
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">idle state</span>
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">reset variables</span>
    tick_count = 0;
    bit_count  = 0;

    former_val = actual_val;
    actual_val = _IN_LINE;

    <span style="color: #00af00;">if</span>(former_val != actual_val)
    {
      tick_count = 0;
      bit_count  = 0; <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">add start bit</span>
      dali_state = RECEIVING_DATA;
    }
  }

  <span style="color: #00af00;">if</span>(dali_state == SENDING_DATA)
  {
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">sending commands</span>

  }

  <span style="color: #00af00;">if</span>(dali_state == RECEIVING_DATA)
  {
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">receiving data from master device</span>

  }

  <span style="color: #00af00;">if</span>(dali_state == FORWARD_FRAME_RECEIVED)
  {
      <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">i</span>;
      <span style="color: #00af00;">volatile</span> <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">anstosend</span>[1];
      <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">reset address &amp; cmd byte values</span>
      slave_addr_byte_received = 0;
      slave_cmd_byte_received  = 0;

      <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">forward frame full received</span>
      dali_state = SETTLING_FF_TO_BF;

      <span style="color: #00af00;">for</span> (i = 1; i &lt; 17; i++) <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">skip first bit - start bit</span>
      {
        <span style="color: #00af00;">if</span>(dali_slave_array_receive_buffer[i] == 1)
        {
          <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">address byte</span>
          <span style="color: #00af00;">if</span>(i &lt; 9)
          {
            slave_addr_byte_received |= (1 &lt;&lt; (8 - i));
          }
          <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">command byte</span>
          <span style="color: #00af00;">else</span>
          {
            slave_cmd_byte_received |= (1 &lt;&lt; (7 - (i - 9)));
          }
        }
      }
      <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">check for response</span>
      <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">DALI_Slave_Check_Received_cmd(slave_cmd_byte_received);</span>

      <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">need to check return value</span>
      dali_slave_answer = DALI_Slave_Execute_command(slave_addr_byte_received, slave_cmd_byte_received);
      anstosend[0] = dali_slave_answer;

      PrepareDataToSend(anstosend, dali_slave_array_response, 1);
  }

  <span style="color: #00af00;">if</span>(dali_state == BACKWARD_FRAME_SENT)
  {
    tick_count = 0;
    bit_count  = 0;

    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">dali_cmd_repeat_time--;</span>
    _OUT_LINE = 1;
    _IN_LINE = 1;
    dali_state = NO_ACTION;
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">redrawUI = TRUE;</span>
  }

  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">check if settling is finished</span>
  <span style="color: #00af00;">if</span>(dali_state == SETTLING_FF_TO_BF_FINISHED)
  {
    dali_state = NO_ACTION;
    <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">does slave device need to response?</span>
    <span style="color: #00af00;">if</span>(slave_cmd_byte_received &gt;= 0x90 &amp;&amp; slave_cmd_byte_received &lt;= 0xC4)
    {
      <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">set state to sending</span>
      dali_state = SENDING_DATA;
      <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">expected_response = FALSE;</span>
      tick_count = 0;
      bit_count  = 0;
    }
    former_val = 1;
    actual_val = 1;
  }
  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">error occur</span>
  <span style="color: #00af00;">if</span>(dali_state == ERR)
  {
    _OUT_LINE  = 1;
    _IN_LINE   = 1;
  }

  <span style="color: #00af00;">return</span> dali_state;
}

<span style="color: #b2b2b2; font-style: italic;">/*******************************************************************************</span>
<span style="color: #b2b2b2; font-style: italic;">Function:       DALI_Slave_Check_Received_Cmd</span>
<span style="color: #b2b2b2; font-style: italic;">Description:    DALI slave check for received command</span>

<span style="color: #b2b2b2; font-style: italic;">******************************************************************************</span><span style="color: #b2b2b2; font-style: italic;">*/</span>

<span style="color: #18b2b2;">void</span> <span style="color: #ef2929;">DALI_Slave_Check_Received_Cmd</span>(<span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">command</span>)
{
  <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">i</span>;

  expected_response = FALSE;

  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">check if response is expected</span>
  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">query commands</span>
  <span style="color: #00af00;">if</span>((command &gt;= 0x90 &amp;&amp; command &lt;= 0xC4))<span style="color: #b2b2b2; font-style: italic;">// </span><span style="color: #b2b2b2; font-style: italic;">|| command == VERIFY_SHORT_ADDRESS || command == QUERY_SHORT_ADDRESS_H)</span>
  {
    expected_response = TRUE;
  }
}

<span style="color: #b2b2b2; font-style: italic;">////////////////////////</span>
<span style="color: #b2b2b2; font-style: italic;">/*******************************************************************************</span>
<span style="color: #b2b2b2; font-style: italic;">Function:       DALI_Slave_Set_Fade</span>
<span style="color: #b2b2b2; font-style: italic;">Description:    Prepare leds for fading</span>

<span style="color: #b2b2b2; font-style: italic;">************************************************************************</span><span style="color: #b2b2b2; font-style: italic;">*/</span>

<span style="color: #18b2b2;">void</span> <span style="color: #ef2929;">DALI_Slave_Set_Fade</span>(<span style="color: #18b2b2;">LightObjectType</span> *<span style="color: #ff8700;">ptrLights</span>, <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">addrByte</span>, <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">fadeTypeDir</span>)
{
 <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">i</span>;
 <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">addrBallast</span>;

  count_fade_steps = 0;
  <span style="color: #00af00;">for</span>(i = 0; i &lt; 10; i++)
    ptrLights[i]._to_fade = FADE_NONE;

  <span style="color: #00af00;">if</span>(addrByte == BROADCAST_CMD)
  {
    <span style="color: #00af00;">for</span>(i = 0; i &lt; 10; i++)
    {
      ptrLights[i]._to_fade = fadeTypeDir;
    }
  }
  <span style="color: #00af00;">else</span> <span style="color: #00af00;">if</span> ((addrByte &amp; GROUP_ADDRESS) == 0x80)
  {
    <span style="color: #00af00;">for</span> (i=0; i &lt; 10; i++)
    {
      <span style="color: #00af00;">if</span>(DALI_Slave_Has_Group(ptrLights, i, addrByte))
      {
        ptrLights[i]._to_fade = fadeTypeDir;
      }
    }
  }
  <span style="color: #00af00;">else</span>
  {
     <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">get address</span>
     addrBallast = DALI_Slave_getAddressFromByte(addrByte);
     ptrLights[addrBallast]._to_fade = fadeTypeDir;
  }
}

<span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ef2929;">DALI_Slave_Has_Group</span>(<span style="color: #18b2b2;">LightObjectType</span> *<span style="color: #ff8700;">lightObjs</span>, <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">ObjId</span>, <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">addrByte</span>)
{
  <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">groupAddress</span>;
  <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">tmpGroupValue</span>;

  groupAddress = addrByte &lt;&lt; 3;
  groupAddress = groupAddress &gt;&gt; 4;

  <span style="color: #00af00;">if</span>(groupAddress &lt; 8)
  {
    tmpGroupValue = *(ptrAddr + BALLAST_SLAVE_OFFSET * lightObjs[ObjId]._address + BALLAST_GROUP_0_7);
    <span style="color: #00af00;">if</span>(tmpGroupValue &amp; (1 &lt;&lt; groupAddress))
    {
      <span style="color: #00af00;">return</span> TRUE;
    }
  }
  <span style="color: #00af00;">else</span>
  {
    tmpGroupValue = *(ptrAddr + BALLAST_SLAVE_OFFSET * lightObjs[ObjId]._address + BALLAST_GROUP_8_15);
    <span style="color: #00af00;">if</span>(tmpGroupValue &amp; (1 &lt;&lt; (groupAddress - 8)))
    {
      <span style="color: #00af00;">return</span> TRUE;
    }
  }
  <span style="color: #00af00;">return</span> FALSE;
}

<span style="color: #18b2b2;">void</span> <span style="color: #ef2929;">DALI_Slave_Set_Arc_Level_Direct</span>(<span style="color: #18b2b2;">LightObjectType</span> *<span style="color: #ff8700;">lightObjs</span>, <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">ObjId</span>, <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">arcValue</span>)
{
  lightObjs[ObjId]._arcLevel = arcValue;
  DALI_Slave_WriteArcValue(lightObjs[ObjId]._address, lightObjs[ObjId]._arcLevel);
}

<span style="color: #18b2b2;">void</span> <span style="color: #ef2929;">DALI_Slave_Set_Arc_Level</span>(<span style="color: #18b2b2;">LightObjectType</span> *<span style="color: #ff8700;">lightObjs</span>, <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">ObjId</span>,
                                <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">valueType</span>, <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">ledOn</span>)
{
  lightObjs[ObjId]._on = ledOn;
  lightObjs[ObjId]._arcLevel = *(ptrAddr + BALLAST_SLAVE_OFFSET * lightObjs[ObjId]._address + valueType);
  DALI_Slave_WriteArcValue(lightObjs[ObjId]._address, lightObjs[ObjId]._arcLevel);
}

<span style="color: #18b2b2;">void</span> <span style="color: #ef2929;">DALI_Slave_TurnOff_Ballast</span>(<span style="color: #18b2b2;">LightObjectType</span> *<span style="color: #ff8700;">lightObjs</span>, <span style="color: #18b2b2;">unsigned</span> <span style="color: #18b2b2;">char</span> <span style="color: #ff8700;">ObjId</span>)
{
  lightObjs[ObjId]._on = FALSE;
  lightObjs[ObjId]._arcLevel = 0;
  <span style="color: #b2b2b2; font-style: italic;">//</span><span style="color: #b2b2b2; font-style: italic;">for every ballast write value to Actual Dim Level</span>
  DALI_Slave_WriteArcValue(lightObjs[ObjId]._address, lightObjs[ObjId]._arcLevel);
  DALI_Slave_PWM_Set_Duty(lightObjs[ObjId]._arcLevel, lightObjs[ObjId]._address);
}

</pre>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Foo X. Bar</p>
<p class="date">Created: 2017-11-14 Di 17:24</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
